{"version":3,"sources":["../../src/adapters/RxPool.js"],"names":["util","RxPool","pool","Pool","_pool","_tclientSource","undefined","autoRelease","log","Observable","fromPromise","connect","flatMap","using","client","of","rxClient","do","end","map","queryText","values","query"],"mappings":";;;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;AACA;;IAAYA,I;;;;;;;;AAEZ;;;IAGqBC,M;AACjB;;;AAGA,oBAAYC,IAAZ,EAAkB;AAAA;;AACd,YAAI,EAAEA,gBAAgB,aAAGC,IAArB,CAAJ,EAAgC;AAC5B,kBAAM,wBAAgB,qCAAhB,CAAN;AACH;;AAED;;;;AAIA,aAAKC,KAAL,GAAaF,IAAb;AACA;;;;AAIA,aAAKG,cAAL,GAAsBC,SAAtB;AACH;;AAED;;;;;;;;;AAOA;;;;kCAI4B;AAAA,gBAApBC,WAAoB,uEAAN,IAAM;;AACxBP,iBAAKQ,GAAL,CAAS,8BAAT;;AAEA,mBAAO,eAAGC,UAAH,CAAcC,WAAd,CAA0B,KAAKN,KAAL,CAAWO,OAAX,EAA1B,EACFC,OADE,CAEC;AAAA,uBAAUL,cACA,eAAGE,UAAH,CAAcI,KAAd,CACI;AAAA,2BAAM,uBAAaC,MAAb,CAAN;AAAA,iBADJ,EAEI;AAAA,2BAAY,eAAGL,UAAH,CAAcM,EAAd,CAAiBC,QAAjB,CAAZ;AAAA,iBAFJ,CADA,GAKA,eAAGP,UAAH,CAAcM,EAAd,CAAiB,uBAAaD,MAAb,CAAjB,CALV;AAAA,aAFD,EASFG,EATE,CASC;AAAA,uBAAMjB,KAAKQ,GAAL,CAAS,0BAAT,CAAN;AAAA,aATD,CAAP;AAUH;;AAED;;;;;;+BAGO;AACH,mBAAO,KAAKG,OAAL,EAAP;AACH;;AAED;;;;;;8BAGM;AAAA;;AACFX,iBAAKQ,GAAL,CAAS,wBAAT;;AAEA,mBAAO,eAAGC,UAAH,CAAcC,WAAd,CAA0B,KAAKN,KAAL,CAAWc,GAAX,EAA1B,EACFC,GADE,CACE;AAAA;AAAA,aADF,EAEFF,EAFE,CAEC,YAAM;AACN,sBAAKZ,cAAL,GAAsBC,SAAtB;;AAEAN,qBAAKQ,GAAL,CAAS,oBAAT;AACH,aANE,CAAP;AAOH;;AAED;;;;;;;;8BAKMY,S,EAAWC,M,EAAQ;AACrB,mBAAO,CAAC,KAAKhB,cAAL,IAAuB,KAAKM,OAAL,EAAxB,EACFC,OADE,CACM;AAAA,uBAAYI,SAASM,KAAT,CAAeF,SAAf,EAA0BC,MAA1B,CAAZ;AAAA,aADN,CAAP;AAEH;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;4BA1GW;AACP,mBAAO,KAAKjB,KAAZ;AACH;;;;;;kBA1BgBH,M","file":"RxPool.js","sourcesContent":["import pg from 'pg';\nimport Rx from 'rxjs';\nimport RxClient from './RxClient';\nimport { RxPoolError } from '../errors';\nimport * as util from '../util';\n\n/**\n * Standalone RxJs adapter for `pg.Pool`.\n */\nexport default class RxPool {\n    /**\n     * @param {Pool} pool\n     */\n    constructor(pool) {\n        if (!(pool instanceof pg.Pool)) {\n            throw new RxPoolError('Pool must be instance of Pool class');\n        }\n\n        /**\n         * @type {Pool}\n         * @private\n         */\n        this._pool = pool;\n        /**\n         * @type {Observable}\n         * @private\n         */\n        this._tclientSource = undefined;\n    }\n\n    /**\n     * @return {Pool}\n     */\n    get pool() {\n        return this._pool;\n    }\n\n    /**\n     * @param {boolean} [autoRelease=true] Wrap client as `Rx.Disposable` resource\n     * @return {Observable<RxClient>}\n     */\n    connect(autoRelease = true) {\n        util.log('RxPool: connecting client...');\n\n        return Rx.Observable.fromPromise(this._pool.connect())\n            .flatMap(\n                client => autoRelease ?\n                          Rx.Observable.using(\n                              () => new RxClient(client),\n                              rxClient => Rx.Observable.of(rxClient)\n                          ) :\n                          Rx.Observable.of(new RxClient(client))\n            )\n            .do(() => util.log('RxPool: client connected'));\n    }\n\n    /**\n     * @return {Observable<RxClient>}\n     */\n    take() {\n        return this.connect();\n    }\n\n    /**\n     * @return {Observable<RxPool>}\n     */\n    end() {\n        util.log('RxPool: ending pool...');\n\n        return Rx.Observable.fromPromise(this._pool.end())\n            .map(() => this)\n            .do(() => {\n                this._tclientSource = undefined;\n\n                util.log('RxPool: pool ended');\n            });\n    }\n\n    /**\n     * @param {string} queryText\n     * @param {Array} [values]\n     * @return {Rx.Observable<Object>}\n     */\n    query(queryText, values) {\n        return (this._tclientSource || this.connect())\n            .flatMap(rxClient => rxClient.query(queryText, values));\n    }\n\n    // /**\n    //  * @return {Rx.Observable<RxPool>}\n    //  */\n    // begin() {\n    //     this._tclientSource = (this._tclientSource || this.connect())\n    //         .flatMap(rxClient => rxClient.begin())\n    //         .shareReplay(1);\n    //\n    //     return this._tclientSource.map(() => this);\n    // }\n    //\n    // /**\n    //  * @param {boolean} [force] Commit transaction with all savepoints.\n    //  * @return {Rx.Observable<RxPool>}\n    //  * @throws {RxPoolError}\n    //  */\n    // commit(force) {\n    //     if (!this._tclientSource) {\n    //         throw new RxPoolError('Client with open transaction does not exists');\n    //     }\n    //\n    //     this._tclientSource = this._tclientSource.flatMap(rxClient => rxClient.commit(force))\n    //         .do(rxClient => {\n    //             if (rxClient.tlevel === 0) {\n    //                 this._tclientSource = undefined;\n    //             }\n    //         })\n    //         .shareReplay(1);\n    //\n    //     return this._tclientSource.map(() => this);\n    // }\n    //\n    // /**\n    //  * @param {boolean} [force] Rollback transaction with all savepoints.\n    //  * @return {Rx.Observable<RxPool>}\n    //  * @throws {RxPoolError}\n    //  */\n    // rollback(force) {\n    //     if (!this._tclientSource) {\n    //         throw new RxPoolError('Client with open transaction does not exists');\n    //     }\n    //\n    //     this._tclientSource = this._tclientSource.flatMap(rxClient => rxClient.rollback(force))\n    //         .do(rxClient => {\n    //             if (rxClient.tlevel === 0) {\n    //                 this._tclientSource = undefined;\n    //             }\n    //         })\n    //         .shareReplay(1);\n    //\n    //     return this._tclientSource.map(() => this);\n    // }\n}\n"]}