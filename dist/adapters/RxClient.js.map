{"version":3,"sources":["../../src/adapters/RxClient.js"],"names":["util","RxClient","client","Client","_client","_tlevel","err","release","Observable","create","once","subscriber","error","complete","next","connected","of","connect","bindNodeCallback","do","log","end","queryText","values","flatMap","query","connection","stream","readyState"],"mappings":";;;;;;;;AAAA;;;;AACA;;;;AACA;;AACA;;IAAYA,I;;;;;;;;AAEZ;;;IAGqBC,Q;AACjB;;;AAGA,sBAAYC,MAAZ,EAAoB;AAAA;;AAChB,YAAI,EAAEA,kBAAkB,aAAGC,MAAvB,CAAJ,EAAoC;AAChC,kBAAM,0BAAkB,yCAAlB,CAAN;AACH;;AAED;;;;AAIA,aAAKC,OAAL,GAAeF,MAAf;AACA;;;;AAIA,aAAKG,OAAL,GAAe,CAAf;AACH;;AAED;;;;;;;;;AAqBA;;;;;;gCAMQC,G,EAAK;AAAA;;AACT,mBAAO,KAAKF,OAAL,CAAaG,OAApB,KAAgC,UAAhC,IAA8C,KAAKH,OAAL,CAAaG,OAAb,CAAqBD,GAArB,CAA9C;AACA,iBAAKD,OAAL,GAAe,CAAf;;AAEA,mBAAO,eAAGG,UAAH,CAAcC,MAAd,CAAqB,sBAAc;AACtC,oBAAIH,GAAJ,EAAS;AACL,0BAAKF,OAAL,CAAaM,IAAb,CAAkB,KAAlB,EAAyB,YAAM;AAC3BC,mCAAWC,KAAX,CAAiBN,GAAjB;AACAK,mCAAWE,QAAX;AACH,qBAHD;AAIH,iBALD,MAKO;AACHF,+BAAWG,IAAX;AACAH,+BAAWE,QAAX;AACH;AACJ,aAVM,CAAP;AAWH;;AAED;;;;;;kCAGU;AAAA;AAAA;;AACN,gBAAI,KAAKE,SAAT,EAAoB;AAChB,uBAAO,eAAGP,UAAH,CAAcQ,EAAd,CAAiB,IAAjB,CAAP;AACH;;AAED,gBAAMC,UAAU,eAAGT,UAAH,CAAcU,gBAAd,CAAiC,iBAAKd,OAAL,EAAaa,OAA9C,iBAAuD;AAAA;AAAA,aAAvD,CAAhB;;AAEA,mBAAOA,UAAUE,EAAV,CAAa;AAAA,uBAAMnB,KAAKoB,GAAL,CAAS,4BAAT,CAAN;AAAA,aAAb,CAAP;AACH;;AAED;;;;;;8BAGM;AAAA;AAAA;;AACF,gBAAI,CAAC,KAAKL,SAAV,EAAqB;AACjB,uBAAO,eAAGP,UAAH,CAAcQ,EAAd,CAAiB,IAAjB,CAAP;AACH;;AAED,gBAAMK,MAAM,eAAGb,UAAH,CAAcU,gBAAd,CAAiC,kBAAKd,OAAL,EAAaiB,GAA9C,kBAAmD;AAAA;AAAA,aAAnD,CAAZ;;AAEA,mBAAOA,MAAMF,EAAN,CAAS,YAAM;AAClB,uBAAKd,OAAL,GAAe,CAAf;;AAEAL,qBAAKoB,GAAL,CAAS,wBAAT;AACH,aAJM,CAAP;AAKH;;AAED;;;;;;;;8BAKME,S,EAAWC,M,EAAQ;AAAA;;AACrB,mBAAO,KAAKN,OAAL,GACFO,OADE,CACM,YAAM;AAAA;;AACX,oBAAMC,QAAQ,eAAGjB,UAAH,CAAcU,gBAAd,CAAiC,oBAAKd,OAAL,EAAaqB,KAA9C,iBAAd;;AAEA,uBAAOA,MAAMH,SAAN,EAAiBC,MAAjB,CAAP;AACH,aALE,EAMFJ,EANE,CAMC;AAAA,uBAAMnB,KAAKoB,GAAL,CAAS,0BAAT,EAAqCE,SAArC,CAAN;AAAA,aAND,CAAP;AAOH;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;4BAhNa;AACT,mBAAO,KAAKlB,OAAZ;AACH;;AAED;;;;;;4BAGa;AACT,mBAAO,KAAKC,OAAZ;AACH;;AAED;;;;;;4BAGgB;AACZ,mBAAO,KAAKD,OAAL,CAAasB,UAAb,CAAwBC,MAAxB,CAA+BC,UAA/B,KAA8C,MAArD;AACH;;;;;;kBAxCgB3B,Q","file":"RxClient.js","sourcesContent":["import pg from 'pg';\nimport Rx from 'rxjs';\nimport { RxClientError } from '../errors';\nimport * as util from '../util';\n\n/**\n * Standalone RxJs adapter for `pg.Client`.\n */\nexport default class RxClient {\n    /**\n     * @param {Client} client\n     */\n    constructor(client) {\n        if (!(client instanceof pg.Client)) {\n            throw new RxClientError('Client must be instance of Client class');\n        }\n\n        /**\n         * @type {Client}\n         * @private\n         */\n        this._client = client;\n        /**\n         * @type {number}\n         * @private\n         */\n        this._tlevel = 0;\n    }\n\n    /**\n     * @type {Client}\n     */\n    get client() {\n        return this._client;\n    }\n\n    /**\n     * @type {number}\n     */\n    get tlevel() {\n        return this._tlevel;\n    }\n\n    /**\n     * @return {boolean}\n     */\n    get connected() {\n        return this._client.connection.stream.readyState === 'open';\n    }\n\n    /**\n     * Releases client acquired from pool\n     *\n     * @param {Error} [err]\n     * @return {Observable<RxClient>}\n     */\n    release(err) {\n        typeof this._client.release === 'function' && this._client.release(err);\n        this._tlevel = 0;\n\n        return Rx.Observable.create(subscriber => {\n            if (err) {\n                this._client.once('end', () => {\n                    subscriber.error(err);\n                    subscriber.complete();\n                });\n            } else {\n                subscriber.next(this);\n                subscriber.complete();\n            }\n        });\n    }\n\n    /**\n     * @return {Observable<RxClient>}\n     */\n    connect() {\n        if (this.connected) {\n            return Rx.Observable.of(this);\n        }\n\n        const connect = Rx.Observable.bindNodeCallback(::this._client.connect, () => this);\n\n        return connect().do(() => util.log('RxClient: client connected'));\n    }\n\n    /**\n     * @return {Observable<RxClient>}\n     */\n    end() {\n        if (!this.connected) {\n            return Rx.Observable.of(this);\n        }\n\n        const end = Rx.Observable.bindNodeCallback(::this._client.end, () => this);\n\n        return end().do(() => {\n            this._tlevel = 0;\n\n            util.log('RxClient: client ended');\n        });\n    }\n\n    /**\n     * @param {string} queryText\n     * @param {Array} [values]\n     * @return {Observable<Object>}\n     */\n    query(queryText, values) {\n        return this.connect()\n            .flatMap(() => {\n                const query = Rx.Observable.bindNodeCallback(::this._client.query);\n\n                return query(queryText, values);\n            })\n            .do(() => util.log('RxClient: query executed', queryText));\n    }\n\n    // /**\n    //  * @return {Rx.Observable<RxClient>}\n    //  */\n    // begin() {\n    //     assert(this._tlevel >= 0, 'Current transaction level >= 0');\n    //\n    //     util.log('begin transaction');\n    //      // todo doOnError => reset tlevel\n    //     this._transactionSource = (this._transactionSource || Rx.Observable.return(null))\n    //         .flatMap(() => {\n    //             let query;\n    //\n    //             if (this._tlevel === 0) {\n    //                 query = 'begin';\n    //             } else {\n    //                 query = `savepoint point_${this._tlevel}`;\n    //             }\n    //\n    //             return this.query(query);\n    //         })\n    //         .do(() => {\n    //             ++this._tlevel;\n    //\n    //             util.log('transaction started', this._tlevel);\n    //         })\n    //         .map(() => this)\n    //         .shareReplay(1);\n    //\n    //     return this._transactionSource;\n    // }\n    //\n    // /**\n    //  * @param {boolean} [force] Commit transaction with all savepoints.\n    //  * @return {Rx.Observable<RxClient>}\n    //  * @throws {RxClientError}\n    //  */\n    // commit(force) {\n    //     assert(this._tlevel >= 0, 'Current transaction level >= 0');\n    //\n    //     if (!this._transactionSource) {\n    //         throw new RxClientError('The transaction is not open on the client');\n    //     }\n    //\n    //     util.log('commit transaction');\n    //\n    //     this._transactionSource = this._transactionSource.flatMap(() => {\n    //         if (this._tlevel === 0) {\n    //             throw new RxClientError('The transaction is not open on the client');\n    //         }\n    //\n    //         /** @type {Rx.Observable} */\n    //         let source;\n    //\n    //         if (this._tlevel === 1 || force) {\n    //             source = this.query('commit')\n    //                 .do(() => {\n    //                     util.log(`transaction committed ${force ? '(force)' : ''}`, this._tlevel);\n    //\n    //                     this._tlevel = 0;\n    //                     this._transactionSource = undefined;\n    //                 });\n    //         } else {\n    //             source = this.query(`release savepoint point_${this._tlevel - 1}`)\n    //                 .do(() => {\n    //                     util.log('transaction committed', this._tlevel);\n    //\n    //                     --this._tlevel;\n    //                 });\n    //         }\n    //\n    //         return source;\n    //     }).map(() => this)\n    //         .shareReplay(1);\n    //\n    //\n    //     return this._transactionSource;\n    // }\n    //\n    // /**\n    //  * @param {boolean} [force] Rollback transaction with all savepoints.\n    //  * @return {Rx.Observable<RxClient>}\n    //  * @throws {RxClientError}\n    //  */\n    // rollback(force) {\n    //     assert(this._tlevel >= 0, 'Current transaction level >= 0');\n    //\n    //     if (!this._transactionSource) {\n    //         throw new RxClientError('The transaction is not open on the client');\n    //     }\n    //\n    //     util.log('rollback transaction');\n    //\n    //     this._transactionSource = this._transactionSource.flatMap(() => {\n    //         if (this._tlevel === 0) {\n    //             throw new RxClientError('The transaction is not open on the client');\n    //         }\n    //\n    //         /** @type {Rx.Observable} */\n    //         let source;\n    //\n    //         if (this._tlevel === 1 || force) {\n    //             source = this.query('rollback')\n    //                 .do(() => {\n    //                     util.log(`transaction rolled back ${force ? '(force)' : ''}`, this._tlevel);\n    //\n    //                     this._tlevel = 0;\n    //                     this._transactionSource = undefined;\n    //                 });\n    //         } else {\n    //             source = this.query(`rollback to savepoint point_${this._tlevel - 1}`)\n    //                 .do(() => {\n    //                     util.log('transaction rolled back', this._tlevel);\n    //\n    //                     --this._tlevel;\n    //                 });\n    //         }\n    //\n    //         return source;\n    //     }).map(() => this)\n    //         .shareReplay(1);\n    //\n    //     return this._transactionSource;\n    // }\n}\n"]}